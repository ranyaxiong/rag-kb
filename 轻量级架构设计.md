# RAG知识库应用 - 轻量级架构设计

## 1. 整体架构概览

### 1.1 设计原则
- **简单优先**：优先实现核心功能，避免过度设计
- **快速开发**：使用成熟框架，减少开发时间
- **容器化**：Docker部署，保证环境一致性
- **模块化**：清晰的模块划分，便于后续扩展

### 1.2 简化架构图

```
┌─────────────────────────────────────┐
│           Streamlit 前端             │
│        (用户界面 + 文件上传)           │
└─────────────────┬───────────────────┘
                  │ HTTP API调用
┌─────────────────┴───────────────────┐
│          FastAPI 后端服务            │
│  ┌─────────────────────────────────┐ │
│  │        LangChain 核心           │ │
│  │   文档处理 + RAG问答逻辑        │ │
│  └─────────────────────────────────┘ │
└─────────────────┬───────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
┌───▼────┐  ┌────▼────┐  ┌────▼────┐
│ChromaDB│  │本地文件  │  │LLM API   │
│向量存储 │  │存储      │  │OpenAI    │
└────────┘  └─────────┘  └─────────┘
```

## 2. 技术栈选择

### 2.1 前端技术
- **框架**：Streamlit 1.28+
  - 快速构建数据应用界面
  - 内置文件上传和表单组件
  - 简单的状态管理
  - 实时预览和调试

### 2.2 后端技术
- **Web框架**：FastAPI 0.104+
  - 高性能异步框架
  - 自动API文档生成
  - 类型提示支持
  - 与LangChain良好集成

- **RAG框架**：LangChain 0.1+
  - 成熟的LLM应用开发框架
  - 丰富的文档处理器
  - 内置RAG模式支持
  - 活跃的社区和文档

### 2.3 数据存储
- **向量数据库**：ChromaDB 0.4+
  - 轻量级本地向量数据库
  - 零配置启动
  - Python原生支持
  - 持久化存储

- **文件存储**：本地文件系统
  - 简单的文件上传存储
  - 按日期组织目录结构
  - 支持多种文档格式

### 2.4 外部服务
- **LLM服务**：OpenAI GPT-3.5-turbo
  - 成熟稳定的API
  - 合理的性能价格比
  - 良好的中文支持

- **嵌入模型**：OpenAI text-embedding-ada-002
  - 高质量向量表示
  - 与GPT模型配合良好
  - API调用简单稳定

## 3. 核心模块设计

### 3.1 项目结构

```
rag-kb-prototype/
├── app/
│   ├── main.py              # FastAPI应用入口
│   ├── api/
│   │   ├── __init__.py
│   │   ├── documents.py     # 文档管理API
│   │   └── qa.py           # 问答API
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py       # 配置管理
│   │   ├── document_processor.py  # 文档处理
│   │   ├── vector_store.py # 向量存储
│   │   └── qa_engine.py    # 问答引擎
│   └── models/
│       ├── __init__.py
│       └── schemas.py      # 数据模型
├── frontend/
│   ├── streamlit_app.py    # Streamlit应用
│   └── components/
│       ├── file_upload.py  # 文件上传组件
│       └── chat_interface.py  # 聊天界面
├── data/
│   ├── uploads/            # 上传文件存储
│   └── chroma_db/          # ChromaDB数据
├── tests/
│   ├── __init__.py
│   ├── test_api.py
│   └── test_core.py
├── docker/
│   ├── Dockerfile.backend
│   ├── Dockerfile.frontend
│   └── docker-compose.yml
├── .github/
│   └── workflows/
│       └── ci-cd.yml       # GitHub Actions
├── requirements.txt
├── .env.example
└── README.md
```

### 3.2 核心模块详解

#### 3.2.1 文档处理器 (DocumentProcessor)
```python
class DocumentProcessor:
    """文档处理核心类"""
    
    def __init__(self):
        self.loaders = {
            '.pdf': PyPDFLoader,
            '.docx': UnstructuredWordDocumentLoader,
            '.txt': TextLoader,
            '.md': UnstructuredMarkdownLoader
        }
        self.text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=1000,
            chunk_overlap=200
        )
    
    def process_document(self, file_path: str) -> List[Document]:
        """处理单个文档，返回分块后的文档片段"""
        
    def batch_process(self, file_paths: List[str]) -> List[Document]:
        """批量处理多个文档"""
```

#### 3.2.2 向量存储 (VectorStore)
```python
class VectorStore:
    """向量存储管理类"""
    
    def __init__(self, persist_directory: str):
        self.chroma_client = chromadb.PersistentClient(
            path=persist_directory
        )
        self.collection = None
        
    def add_documents(self, documents: List[Document]):
        """添加文档到向量存储"""
        
    def similarity_search(self, query: str, k: int = 4) -> List[Document]:
        """向量相似度搜索"""
        
    def delete_document(self, doc_id: str):
        """删除指定文档"""
```

#### 3.2.3 问答引擎 (QAEngine)
```python
class QAEngine:
    """RAG问答引擎"""
    
    def __init__(self, vector_store: VectorStore, llm_api_key: str):
        self.vector_store = vector_store
        self.llm = ChatOpenAI(
            model_name="gpt-3.5-turbo",
            api_key=llm_api_key,
            temperature=0
        )
        self.qa_chain = self._build_qa_chain()
        
    def ask(self, question: str) -> Dict:
        """回答问题并返回答案和来源"""
        
    def _build_qa_chain(self):
        """构建问答链"""
        return RetrievalQA.from_chain_type(
            llm=self.llm,
            chain_type="stuff",
            retriever=self.vector_store.as_retriever(),
            return_source_documents=True
        )
```

## 4. API设计

### 4.1 文档管理API

```python
# POST /api/documents/upload
{
    "file": "multipart/form-data",
    "category": "optional_string"
}

# GET /api/documents
{
    "documents": [
        {
            "id": "uuid",
            "filename": "string",
            "upload_time": "datetime",
            "status": "processed|processing|failed",
            "chunk_count": "integer"
        }
    ]
}

# DELETE /api/documents/{document_id}
{
    "message": "Document deleted successfully"
}
```

### 4.2 问答API

```python
# POST /api/qa/ask
{
    "question": "string",
    "max_sources": "integer (default: 3)"
}

# Response
{
    "answer": "string",
    "sources": [
        {
            "document_name": "string",
            "content": "string",
            "similarity_score": "float"
        }
    ],
    "processing_time": "float"
}
```

## 5. 前端界面设计

### 5.1 Streamlit应用结构

```python
# streamlit_app.py
import streamlit as st
from components.file_upload import FileUploadComponent
from components.chat_interface import ChatInterface

def main():
    st.set_page_config(
        page_title="RAG知识库",
        page_icon="📚",
        layout="wide"
    )
    
    # 侧边栏 - 文档管理
    with st.sidebar:
        st.title("📚 文档管理")
        FileUploadComponent().render()
        
    # 主界面 - 问答系统
    st.title("🤖 智能问答")
    ChatInterface().render()

if __name__ == "__main__":
    main()
```

### 5.2 用户界面布局

```
┌─────────────────────────────────────────────────────┐
│                    RAG知识库                          │
├───────────────┬─────────────────────────────────────┤
│   文档管理     │            智能问答                   │
│               │                                     │
│ 📄 上传文档    │  💬 请输入您的问题...                 │
│ ├─ 选择文件    │  ┌─────────────────────────────────┐ │
│ ├─ 上传按钮    │  │                                 │ │
│ └─ 处理状态    │  │         问题输入框               │ │
│               │  │                                 │ │
│ 📋 文档列表    │  └─────────────────────────────────┘ │
│ ├─ doc1.pdf   │  [发送问题]                          │
│ ├─ doc2.docx  │                                     │
│ └─ doc3.txt   │  🤖 AI回答：                        │
│               │  根据您上传的文档，这个问题的答案是...  │
│ 🗑️ 删除文档   │                                     │
│               │  📖 相关文档片段：                   │
│               │  • 来源：doc1.pdf                   │
│               │    内容摘要...                       │
└───────────────┴─────────────────────────────────────┘
```

## 6. Docker部署配置

### 6.1 多阶段Dockerfile

```dockerfile
# Dockerfile.backend
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY app/ ./app/
COPY .env ./

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

```dockerfile
# Dockerfile.frontend
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir streamlit requests

# 复制前端代码
COPY frontend/ .

EXPOSE 8501

CMD ["streamlit", "run", "streamlit_app.py", "--server.address", "0.0.0.0"]
```

### 6.2 Docker Compose配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CHROMA_DB_PATH=/app/data/chroma_db
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    ports:
      - "8501:8501"
    depends_on:
      - backend
    environment:
      - BACKEND_URL=http://backend:8000
    restart: unless-stopped

volumes:
  app_data:
```

## 7. GitHub Actions CI/CD

### 7.1 自动化工作流

```yaml
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        pytest tests/ --cov=app --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker images
      run: |
        docker build -t rag-kb-backend:latest -f docker/Dockerfile.backend .
        docker build -t rag-kb-frontend:latest -f docker/Dockerfile.frontend .
    
    - name: Save Docker images
      run: |
        docker save rag-kb-backend:latest | gzip > backend.tar.gz
        docker save rag-kb-frontend:latest | gzip > frontend.tar.gz
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: docker-images
        path: |
          backend.tar.gz
          frontend.tar.gz

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to staging
      run: |
        echo "部署到测试环境"
        # 这里可以添加具体的部署脚本
```

## 8. 开发和部署流程

### 8.1 本地开发
```bash
# 1. 克隆项目
git clone <repository-url>
cd rag-kb-prototype

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# or
venv\Scripts\activate     # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑.env文件，添加OpenAI API Key

# 5. 启动后端服务
uvicorn app.main:app --reload

# 6. 启动前端服务（新终端）
streamlit run frontend/streamlit_app.py
```

### 8.2 Docker部署
```bash
# 1. 构建和启动所有服务
docker-compose up -d --build

# 2. 查看服务状态
docker-compose ps

# 3. 查看日志
docker-compose logs -f

# 4. 停止服务
docker-compose down
```

### 8.3 生产部署
- 使用GitHub Actions自动构建Docker镜像
- 部署到云服务器（AWS EC2、阿里云ECS等）
- 配置域名和HTTPS证书
- 设置定期备份和监控

## 9. 性能优化建议

### 9.1 后端优化
- 使用异步处理文档上传和处理
- 实现简单的缓存机制（内存缓存）
- 限制同时处理的文档数量
- 优化ChromaDB的检索参数

### 9.2 前端优化
- 使用Streamlit的缓存装饰器
- 实现文件上传进度显示
- 添加错误处理和用户提示
- 优化界面响应性

### 9.3 成本控制
- 设置OpenAI API调用频率限制
- 实现问题预处理，避免无效查询
- 缓存常见问题的答案
- 监控API调用成本

## 10. 监控和维护

### 10.1 基础监控
- Docker容器健康检查
- 应用日志记录和轮转
- 磁盘空间监控
- API响应时间监控

### 10.2 错误处理
- 全局异常处理
- 用户友好的错误提示
- 自动重试机制
- 错误日志聚合

这个轻量级架构设计专注于快速实现RAG知识库的核心功能，使用成熟的技术栈确保开发效率，同时保持了良好的扩展性为后续功能增强打下基础。